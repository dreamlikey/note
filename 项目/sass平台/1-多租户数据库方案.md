## **多租户（Multi-Tenant）数据库方案详解**

多租户（Multi-Tenant）数据库设计是 SaaS（Software as a Service）架构的核心，决定了如何存储和管理多个租户（Tenant）的数据。合理的设计可以提高**性能、隔离性、安全性、可扩展性**。

------

# **🌟 1. 多租户数据库的设计模式**

不同的业务场景和数据规模适合不同的数据库架构，主要有 **三种** 经典方案：

1. **共享数据库，单表存储所有租户数据（单库单表）**
2. **共享数据库，每个租户一个独立的表（单库多表）**
3. **独立数据库，每个租户一个数据库（多库）**

此外，在大规模 SaaS 场景下，还可以采用： 4. **分库分表 + 分布式数据库架构（Sharding）**
 \5. **混合模式（Hybrid）**

------

## **📌 方案 1：共享数据库，单表区分租户**

> **适用于**：小型或中型 SaaS 平台，租户数据量不是特别大，开发成本低。

### **💡 设计思路**

所有租户的数据存放在**同一个数据库的同一张表**，**通过 `tenant_id` 字段区分不同租户**。

```sql
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tenant_id BIGINT NOT NULL,  -- 租户 ID，数据隔离关键字段
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_user (user_id)
);
```

### **✅ 优势**

✔ **开发和维护成本低**，只需管理一套表结构。
 ✔ **扩展性好**，租户增长不会影响架构。
 ✔ **适合数据量小的 SaaS**，所有数据都可以快速查询。

### **❌ 劣势**

❌ **数据量大时查询变慢**，需要额外索引优化。
 ❌ **安全隔离性较差**，需要严格控制 `tenant_id` 访问权限（可以使用 **Row-Level Security (RLS)**）。
 ❌ **备份 & 迁移复杂**，不同租户的数据混在一起，不容易拆分。

------

## **📌 方案 2：共享数据库，按租户分表**

> **适用于**：租户数据量较大，但仍希望共享数据库的情况。

### **💡 设计思路**

每个租户使用**独立的表**，但所有表的结构一致。

- 表名格式：`orders_租户ID`
- 例如：
  - `orders_1001`（租户 1001）
  - `orders_1002`（租户 1002）

```sql
CREATE TABLE orders_1001 (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **✅ 优势**

✔ **查询性能高**，每个租户的数据是独立表，不会影响其他租户。
 ✔ **数据隔离性强**，不同租户之间数据完全分离。
 ✔ **适合中大型 SaaS**，避免单表数据过大导致的性能问题。

### **❌ 劣势**

❌ **表管理复杂**，每个新租户都要创建一张表（可以用**动态 SQL** 或 **自动分表**工具）。
 ❌ **跨租户查询困难**，如果要做全平台统计，需要 `UNION ALL` 查询多个表，性能会受影响。

------

## **📌 方案 3：独立数据库，每个租户一个数据库**

> **适用于**：大企业 SaaS，租户规模大、数据量大，且有严格的数据隔离要求。

### **💡 设计思路**

- 每个租户

  独立一个数据库

  ，如：

  - `tenant_1001_db`
  - `tenant_1002_db`

- 所有数据库的表结构相同：

```sql
CREATE DATABASE tenant_1001_db;
CREATE DATABASE tenant_1002_db;
```

每个数据库中的 `orders` 表：

```sql
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **✅ 优势**

✔ **最强隔离性**，适用于**金融、政府、医疗等对安全要求高的业务**。
 ✔ **可单独扩展**，每个租户的数据库可以放在不同的服务器上，避免资源竞争。

### **❌ 劣势**

❌ **数据库管理复杂**，新租户需要创建数据库，运维压力大。
 ❌ **资源利用率低**，多个小租户可能导致数据库服务器资源浪费。
 ❌ **跨租户查询困难**，无法在同一 SQL 语句中查询多个租户的数据。

------

## **📌 方案 4：分库分表 + 分布式数据库**

> **适用于**：超大规模 SaaS，海量租户和高并发场景。

### **💡 设计思路**

- 按 **租户 ID** 或 **业务类型**，把数据分布到多个数据库集群中。
- 采用 **分布式数据库（如 ShardingSphere、TiDB、Vitess）**，在多个数据库之间路由查询。

示例：

- 10000 个租户，分布到 10 个数据库：

  ```
  tenant_1 ~ tenant_1000  ➝  db_cluster_1
  tenant_1001 ~ tenant_2000  ➝  db_cluster_2
  ...
  tenant_9001 ~ tenant_10000  ➝  db_cluster_10
  ```

### **✅ 优势**

✔ **高扩展性**，支持**大规模 SaaS**。
 ✔ **高可用、高并发**，适合**电商、社交、在线教育等高流量业务**。

### **❌ 劣势**

❌ **开发复杂**，需要**数据库中间件**或 **自研分片方案**。
 ❌ **运维成本高**，需要自动化管理数据库分片和扩展。

------

# **📌 选择最适合的方案**

| 方案                           | 适用场景                        | 优势                   | 劣势                       |
| ------------------------------ | ------------------------------- | ---------------------- | -------------------------- |
| **共享数据库，单表区分租户**   | **中小型 SaaS**，租户数据量适中 | 结构简单，维护成本低   | 数据量大时查询变慢         |
| **共享数据库，按租户分表**     | **中大型 SaaS**，租户数据量大   | 查询快，数据隔离好     | 需要动态管理表             |
| **独立数据库，每个租户一个库** | **大规模 SaaS、金融、政府**     | 最强数据隔离，安全性高 | 资源利用率低，跨租户查询难 |
| **分布式数据库架构**           | **超大规模 SaaS**               | 高扩展性，高性能       | 需要分库分表中间件         |

------

## **🚀 总结**

- **刚开始搭建 SaaS 平台**：建议使用**“共享数据库 + 租户 ID”**，简单高效。
- **数据量增大时**：可以逐步**迁移到分表或分库架构**。
- **大规模 SaaS**：建议使用**分库分表 + 分布式数据库**，提高扩展性。

这样可以保证 **数据安全、查询性能**，同时具备**良好的扩展能力**🚀！