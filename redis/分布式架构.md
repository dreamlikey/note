## 分布式架构设计原则

这 15 个架构原则来自《架构即未来 (The Art of Scalability)》[附录 2] 一书，作者马丁 L. 阿伯特和迈克尔 T. 费舍尔分别是 eBay 和 PayPal 的前 CTO，他们经历过 eBay 和 PayPal 大规模分布式电商平台的架构演进，在一线实战经验的基础上总结并提炼出 15 条架构原则：

**1.N + 1**

**集群化部署**，设计永远不要少于两个，通常为三个。比方说无状态的 Web/API 一般部署至少>=2 个。

**2. 回滚设计**

确保系统可以回滚到以前发布过的任何版本。通过发布系统保留**历史版本**，或者代码中引入**动态开关切换机制** (Feature Switch)。

**3. 开关设计**

能够关闭任何发布的功能。新功能隐藏在动态开关机制 (Feature Switch) 后面，可以**按需一键打开**，如发现问题**随时关闭**禁用。

**4. 监控设计**

在设计阶段就必须考虑监控，而不是在实施完毕之后补充。例如在需求阶段就要考虑关键指标监控项，这就是度量驱动开发 (Metrics Driven Development) 的理念。

**5. 使用成熟的技术**

只用确实好用的技术。商业组织毕竟不是研究机构，技术要落地实用，成熟的技术一般坑都被踩平了，新技术在完全成熟前一般需要踩坑躺坑。

**6. 异步设计**

能异步尽量用异步，只有当绝对必要或者无法异步时，才使用同步调用。

**7. 无状态系统**

尽可能无状态，只有当业务确实需要，才使用状态。无状态系统易于扩展，有状态系统不易扩展且状态复杂时更易出错。

**8. 水平扩展而非垂直升级**

永远不要依赖更大、更快的硬件设备构建核心业务系统。一般公司成长到一定阶段普遍经历过买更大、更快机器硬件的阶段，即使淘宝当年也买小型机扛流量，后来扛不住才体会这样做不 scalable，所以才有后来的去 IOE 行动。

**9. 前瞻性设计**

设计时至少要有两步前瞻性，在扩展性问题发生前考虑好下一步的行动计划。架构师的价值就体现在这里，架构设计对于流量的增长要有提前量。**设计**支撑短期目标**20**倍容量，**实现**支撑**5倍**以上容量的架构方案开发，**部署2倍**容量的系统。

**10. 非核心则购买**

如果不是你最擅长，也提供不了差异化的竞争优势则直接购买。避免 Not Invented Here 症状，避免重造轮子，达成业务目标才是重点。

**11. 使用商品化硬件**

便宜最好（大多数情况）。这点和第 9 点是一致的，通过商品化硬件水平扩展，而不是买更大、更快的系统。

**12. 小构建、小发布和快速试错**

全部研发要小构建，不断迭代，让系统不断成长。这个和微服务理念一致。

**13. 隔离故障**

通过**断路**保护避免故障**传播和交叉**影响。

故障隔离包括：1.基础组件内的**节点屏蔽**；2.单个系统单个服务**降级、流控**；3.全局流控降级；4.系统**单元化**：通过舱壁泳道等机制隔离失败单元 (Failure Unit)，一个单元的失败不至影响其它单元的正常工作；

**14. 自动化**

自动化设计和构建自动化的过程。如果机器可以做，就不要依赖于人。自动化是 DevOps 的基础

**15. 多活设计**

设计多活数据中心**不要被一个数据中心**的解决方案把自己**限制住**。也要考虑成本和公司规模发展阶段。

TDD （**TEST测试**驱动开发）

BDD （**Behavior行为**驱动开发）

MDD （**Model模型**驱动开发）

DDD （**Domain领域**驱动开发）

MDD （**Metrics度量**驱动开发）

## AKF架构原则







主备、主从

分片

**高可用**

**压力**

方案

1、客户端动态路由

2、代理层路由（redis代理）

3、redis存储散列表

AKF

多级缓存

**12306火车票查询**

bitmap

一个bitmap表示一个车次

|      | 座位1 | 座位2 |
| ---- | ----- | ----- |
| 站1  | 1     | 0     |
| 站2  | 1     | 1     |
| 站3  | 0     | 1     |







ES倒排索引