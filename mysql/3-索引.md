### 索引

**索引是一种加速对表中数据行检索的排好序的数据结构**

分散存储的数据结构

### Mysql常用索引的数据结构

#### B+树

#### Hash索引

[memory存储引擎使用hash索引]

hash索引是采用一定的hash算法，把键值换算成hash值，检索时不需要像B+树那样从根节点到叶子节点逐级查找，只需要一次hash算法即可定位到相应位置速度非常快。

**缺点**：

**1、无法利用hash索引完成范围查找**

虽然hash索引的等值查询非常快，但是范围查询就没有用武之地，因为hash算法后原本有序的键值可能不连续了，没办法利用索引完成范围查找。 

**2、hash索引不支持如like这样的部分模糊查询**

**3、hash索引不支持联合索引的最左匹配规则**




### 索引结构

#### 二叉树

二叉树

​	存在线性链表问题，相当于全表扫描

二叉平衡树

二叉平衡树：叶子节点高度差不能超过1

##### 缺陷

**搜索效率不足**

​	一般来说，在树结构中数据所在深度决定着查找它需要的IO次数，数据量大时，二叉树的深度很大，IO次数多效率低。

**节点数据太少**

每个磁盘块（节点/页）保存的关键字数据量太少，没有很好的利用操作系统与磁盘的数据交换特性和磁盘预读能力（空间局部性原理）



一次IO操作带回来的数据太少，操作系统一次IO操作交互的数据量为一页4KB，一次IO只读取了一个关键字效率太低

##### 结论

二叉树不适合做为数据库索引



#### B树

多路平衡查找树

##### 特点

绝对平衡树

路=关键字+1

路越多数高度越小



##### 与二叉树的优势

1. 一个索引节点（磁盘块）可以存储多个关键字

   每次IO操作读取的关键字个数大大增加 ，减少IO次数

2. 每个节点有关键字+1路，大大降低了树深度

   查询数据的IO次数减少



##### 缺陷

​	查询效率不稳定



#### B+树

加强版多路平衡查找树

![1576669772318](..\1576669772318.png)

##### 特点

数据规则左闭合区间

B+树非叶子节点不保存数据信息，只保存关键字和叶子节点索引

B+树的数据保存在叶子节点，**叶子节点保存有指针指向下一个节点**【**便于范围查找**】



##### 与B树的优势

B+树磁盘读写能里更强

​	非叶子节点不存储数据，保存的关键字更多，每次IO加载的关键字也越多

B+树的排序能力更强

B+树查询效率更加稳定

​	每次查询都经过相同的IO次数，最终都要到叶子节点获取数据（数据只保存在叶子节点）





### 索引类型

Mysql的索引是引擎级别的概念，不同的存储引擎索引结构不一样

#### **InnODB**

Innodb引擎使用聚集索引组织数据的存储 ，索引数据结构与数据存储在一个.IBD文件



![1576670050471](C:\Users\jiachao\AppData\Roaming\Typora\typora-user-images\1576670050471.png)

使用B+Tree作为索引数据结构，数据与索引存方在一个文件中，叶子节点的data域保存了完整的数据，这种索引称为**聚集索引**也叫**主键索引**（索引的关键字key是主键）

##### 聚集索引

![image-20220228165931070](image\聚簇索引.png)

数据库表行中数据的物理顺序与键值的逻辑（索引）顺序相同

索引数据 与 行数据存在一起



##### 辅助索引

数据区存储的**主键值**，通过主键值再次查找聚集索引（主键索引），最终查找到主键索引的数据区的数据

![1576670227550](image\非聚簇索引.jpg)



这样每个辅助索引不需要再维护一份数据，避免数据变化维护多个版本的数据问题【数据一致性问题】

**辅助索引的数据区为什么不存储主键的物理地址而是保存主键值**

**减少维护成本，当索引结构发生变化，不需要维护辅助索引的数据**

主键物理地址

**当索引树发生选择分裂等树结构变化，存储id的物理地址也相应的发生变化，那么还需要修改辅助索引数据区的数据**

主键值

不需要修改辅助索引数据区的数据



#### **MyISAM**

![1576670025388](image\mylsam索引.jpg)

**索引数据结构、数据分开存储，.MYI文件保存索引数据，.MYD文件保存数据**

使用B+Tree作为索引数据结构，数据与索引分开存放在两个不同文件中，**叶子节点的data域存放的是指向数据存放的物理地址**。







### 索引命中规则

**最左匹配原则**

对索引中关键字进行计算（比对），一定是从左往右进行，且不可跳过。单个索引和联合索引都遵循最左匹配原则。



mysql的索引可以以一定顺序引用多个列，这种索引称为联合索引，

一般的，一个联合索引是一个有序元组<a1, a2, …, an>，其中各个元素均为数据表的一列。另外，单列索引可以看成联合索引元素数为1的特例。索引匹配的最左原则具体是说，假如索引列分别为A，B，C，顺序也是A，B，C：

```text
- 那么查询的时候，如果查询【A】【A，B】 【A，B，C】，那么可以通过索引查询
- 如果查询的时候，采用【A，C】，那么C这个虽然是索引，但是由于中间缺失了B，因此C这个索引是用不到的，只能用到A索引
- 如果查询的时候，采用【B】 【B，C】 【C】，由于没有用到第一列索引，不是最左前缀，那么后面的索引也是用不到了
- 如果查询的时候，采用范围查询，并且是最左前缀，也就是第一列索引，那么可以用到索引，但是范围后面的列无法用到索引
```



### 其它概念

三原则

1. 最左匹配原则
2. 离散度原则
3. 空间原则

列的离散性

​	列的离散性越好选择性越好，如果列的重复率高

​	

联合索引

​	多列索引称为联合索引（多个关键字），从这个角度理解单列索引就是一个特殊的联合索引。

对A、B、C三个字段建立联合索引，实际上建立了三个索引每个索引都包含A，A、AB、ABC



覆盖索引

三星索引





### 问题

1、innodb的表一定要创建主键吗？

innodb创建表可以没有主键，innodb存储引擎会默认生成一个主键



2、innodb为什么一定要有主键？

innodb的索引结构是基于聚集索引也称为主键索引，聚集索引节点上存储的是排好序的主键。辅助索引的叶子节点上存储的是主键值，需要拿到主键值再查一次主键索引。所以innodb必须要主键



3、innodb为什么推荐自增主键？

1、方便聚集索引排序，大小比较速度快

2、自增id每插入新数据时只会插入到叶子节点的最后，如果使用非自增id【UUID需要比较字符串asci码大小】插入数据时可能插入到已排序的节点中，造成索引重排序，性能下降。



4、mysql索引使用最左匹配原则的原因？

mysql复合索引的排序规则是 先按照复合索引第一个字段排序，如果相同再比较第二个字段大小排序，按照这种规则第二个字段的顺序其实是打乱的，只有第一个字段是完全顺序，如果绕过第一个索引字段从第二个索引字段开始查找索引树无法准确查找到数据。