åœ¨ Spring + MyBatis **Java Config** æ–¹å¼çš„åŸºç¡€ä¸Šï¼Œå®ç° **è¯»å†™åˆ†ç¦»ï¼ˆä¸»ä»æ•°æ®åº“é…ç½®ï¼‰**ã€‚
æˆ‘ä»¬ä½¿ç”¨ **AbstractRoutingDataSource** å®ç° **åŠ¨æ€æ•°æ®æºåˆ‡æ¢**ï¼Œè®©ï¼š

- **æŸ¥è¯¢ï¼ˆSELECTï¼‰èµ°ä»åº“**
- **æ›´æ–°ï¼ˆINSERT/UPDATE/DELETEï¼‰èµ°ä¸»åº“**

------

## **ğŸ›  å®ç°æ€è·¯**

1. **é…ç½®å¤šä¸ªæ•°æ®æºï¼ˆä¸»åº“ + ä»åº“ï¼‰**
2. **ä½¿ç”¨ `AbstractRoutingDataSource` è¿›è¡ŒåŠ¨æ€åˆ‡æ¢**
3. **åˆ›å»º AOP åˆ‡é¢ï¼Œè‡ªåŠ¨åˆ‡æ¢æ•°æ®æº**
4. **æ•´åˆ MyBatisï¼Œè®©è¯»è¯·æ±‚èµ°ä»åº“ï¼Œå†™è¯·æ±‚èµ°ä¸»åº“**

------

## **ğŸ“Œ 1ï¸âƒ£ ä¾èµ–ï¼ˆpom.xmlï¼‰**

```
xmlå¤åˆ¶ç¼–è¾‘<dependencies>
    <!-- Spring æ ¸å¿ƒ -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.3.30</version>
    </dependency>

    <!-- MyBatis Spring é€‚é… -->
    <dependency>
        <groupId>org.mybatis.spring</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>2.0.7</version>
    </dependency>

    <!-- MyBatis æ ¸å¿ƒ -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.5.13</version>
    </dependency>

    <!-- MySQL é©±åŠ¨ -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.33</version>
    </dependency>

    <!-- HikariCP è¿æ¥æ±  -->
    <dependency>
        <groupId>com.zaxxer</groupId>
        <artifactId>HikariCP</artifactId>
        <version>5.0.1</version>
    </dependency>

    <!-- Spring AOP -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-aop</artifactId>
        <version>5.3.30</version>
    </dependency>
</dependencies>
```

------

## **ğŸ“Œ 2ï¸âƒ£ å®šä¹‰åŠ¨æ€æ•°æ®æº `DynamicDataSource`**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.datasource;

import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;

/**
 * ç»§æ‰¿ AbstractRoutingDataSourceï¼Œå®ç°åŠ¨æ€åˆ‡æ¢æ•°æ®æº
 */
public class DynamicDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceContext.getDataSourceKey();  // è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„æ•°æ®æº
    }
}
```

------

## **ğŸ“Œ 3ï¸âƒ£ çº¿ç¨‹å˜é‡ `DataSourceContext`ï¼ˆç®¡ç†æ•°æ®æºï¼‰**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.datasource;

/**
 * çº¿ç¨‹å˜é‡ï¼Œå­˜å‚¨å½“å‰æ•°æ®åº“è¿æ¥çš„ keyï¼ˆä¸»åº“ or ä»åº“ï¼‰
 */
public class DataSourceContext {
    private static final ThreadLocal<String> CONTEXT_HOLDER = new ThreadLocal<>();

    public static void setDataSourceKey(String key) {
        CONTEXT_HOLDER.set(key);
    }

    public static String getDataSourceKey() {
        return CONTEXT_HOLDER.get();
    }

    public static void clear() {
        CONTEXT_HOLDER.remove();
    }
}
```

------

## **ğŸ“Œ 4ï¸âƒ£ é…ç½®å¤šæ•°æ®æºï¼ˆSpringMyBatisConfig.javaï¼‰**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.config;

import com.example.datasource.DynamicDataSource;
import org.apache.ibatis.session.SqlSessionFactory;
import org.mybatis.spring.SqlSessionFactoryBean;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import com.zaxxer.hikari.HikariDataSource;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;

@Configuration
@ComponentScan(basePackages = "com.example")
@MapperScan("com.example.mapper")
public class SpringMyBatisConfig {

    // 1ï¸âƒ£ é…ç½®ä¸»åº“æ•°æ®æº
    @Bean
    public DataSource masterDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/master_db?useSSL=false&serverTimezone=UTC");
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        dataSource.setMaximumPoolSize(10);
        return dataSource;
    }

    // 2ï¸âƒ£ é…ç½®ä»åº“æ•°æ®æº
    @Bean
    public DataSource slaveDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/slave_db?useSSL=false&serverTimezone=UTC");
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        dataSource.setMaximumPoolSize(10);
        return dataSource;
    }

    // 3ï¸âƒ£ é…ç½®åŠ¨æ€æ•°æ®æº
    @Bean
    public DataSource dataSource(DataSource masterDataSource, DataSource slaveDataSource) {
        DynamicDataSource dynamicDataSource = new DynamicDataSource();
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource);
        dataSourceMap.put("slave", slaveDataSource);
        dynamicDataSource.setTargetDataSources(dataSourceMap);
        dynamicDataSource.setDefaultTargetDataSource(masterDataSource); // é»˜è®¤ä¸»åº“
        return dynamicDataSource;
    }

    // 4ï¸âƒ£ é…ç½® SqlSessionFactory
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        factoryBean.setDataSource(dataSource);
        return factoryBean.getObject();
    }
}
```

------

## **ğŸ“Œ 5ï¸âƒ£ AOP æ‹¦æˆª SQLï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸»åº“/ä»åº“**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.aop;

import com.example.datasource.DataSourceContext;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class DataSourceAspect {

    // æ‹¦æˆªæ‰€æœ‰ Service å±‚çš„æ–¹æ³•
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void serviceMethods() {}

    // è¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰èµ°ä»åº“
    @Before("serviceMethods() && execution(* com.example.service.*.get*(..))")
    public void setReadDataSource() {
        DataSourceContext.setDataSourceKey("slave");
    }

    // å†™æ“ä½œï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰èµ°ä¸»åº“
    @Before("serviceMethods() && execution(* com.example.service.*.insert*(..)) || " +
            "execution(* com.example.service.*.update*(..)) || " +
            "execution(* com.example.service.*.delete*(..))")
    public void setWriteDataSource() {
        DataSourceContext.setDataSourceKey("master");
    }
}
```

------

## **ğŸ“Œ 6ï¸âƒ£ æµ‹è¯•ï¼ˆUserService.javaï¼‰**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.service;

import com.example.mapper.UserMapper;
import com.example.model.User;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;

    public User getUserById(int id) {
        return userMapper.getUserById(id);  // æŸ¥è¯¢èµ°ä»åº“
    }

    public void insertUser(User user) {
        userMapper.insertUser(user);  // å†™å…¥èµ°ä¸»åº“
    }
}
```

------

## **ğŸ¯ ç»“æœ**

1. **æŸ¥è¯¢æ•°æ® â†’ è‡ªåŠ¨ä½¿ç”¨ `slave_db`**
2. **æ’å…¥æ•°æ® â†’ è‡ªåŠ¨ä½¿ç”¨ `master_db`**
3. **æ— é¡»æ‰‹åŠ¨ç®¡ç†æ•°æ®æºï¼ŒAOP è‡ªåŠ¨åˆ‡æ¢**

âœ… **ç°åœ¨ä½ çš„ Spring + MyBatis æ”¯æŒ** **è¯»å†™åˆ†ç¦»**ï¼Œè®©**æŸ¥è¯¢ç”¨ä»åº“ï¼Œå†™å…¥ç”¨ä¸»åº“** ğŸš€





### 1ã€äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜

åœ¨**åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å†™åŒä¸€æ¡æ•°æ®**çš„æƒ…å†µä¸‹ï¼Œ**è¯»å†™åˆ†ç¦»å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´**ï¼Œä¸»è¦åŸå› æ˜¯ï¼š

1. **ä¸»åº“æ•°æ®æœªåŒæ­¥åˆ°ä»åº“**ï¼ˆä¸»ä»åŒæ­¥æœ‰å»¶è¿Ÿï¼‰ã€‚
2. **åŒä¸€äº‹åŠ¡ä¸­ï¼Œå†™å…¥ä¸»åº“çš„æ•°æ®è¿˜æœªæäº¤ï¼Œè€ŒæŸ¥è¯¢ä»åº“ä¸ä¼šçœ‹åˆ°æœ€æ–°æ•°æ®**ã€‚

------

## **ğŸš¨ è§£å†³æ–¹æ¡ˆï¼šäº‹åŠ¡å†…å¼ºåˆ¶ä½¿ç”¨ä¸»åº“**

åœ¨äº‹åŠ¡èŒƒå›´å†…ï¼š

- **æ‰€æœ‰æŸ¥è¯¢ï¼ˆSELECTï¼‰éƒ½å¿…é¡»èµ°ä¸»åº“**
- **ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼Œé¿å…ä»åº“æ•°æ®å»¶è¿Ÿé—®é¢˜**

------

## **âœ… æ–¹æ¡ˆ 1ï¼šäº‹åŠ¡å†…å¼ºåˆ¶ä¸»åº“**

**æ”¹è¿› AOP åˆ‡é¢**ï¼Œåœ¨ **äº‹åŠ¡å¼€å¯æ—¶** **å¼ºåˆ¶ä½¿ç”¨ä¸»åº“**ï¼Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´ã€‚

### **ğŸ“Œ ä¿®æ”¹ `DataSourceAspect.java`**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.aop;

import com.example.datasource.DataSourceContext;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Aspect
@Component
@Order(1) // è®©æ•°æ®æºåˆ‡é¢æ¯”äº‹åŠ¡åˆ‡é¢å…ˆæ‰§è¡Œ
public class DataSourceAspect {

    // 1ï¸âƒ£ **æ ‡è®°æ‰€æœ‰ Service å±‚æ–¹æ³•**
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void serviceMethods() {}

    // 2ï¸âƒ£ **äº‹åŠ¡æ–¹æ³•å†…ï¼Œæ‰€æœ‰æŸ¥è¯¢å¼ºåˆ¶èµ°ä¸»åº“**
    @Before("@annotation(org.springframework.transaction.annotation.Transactional)")
    public void forceMasterInTransaction() {
        DataSourceContext.setDataSourceKey("master");
    }

    // 3ï¸âƒ£ **éäº‹åŠ¡ç¯å¢ƒä¸‹ï¼ŒæŸ¥è¯¢ï¼ˆgetï¼‰èµ°ä»åº“**
    @Before("serviceMethods() && execution(* com.example.service.*.get*(..))")
    public void setReadDataSource() {
        if (DataSourceContext.getDataSourceKey() == null) { // åªæœ‰éäº‹åŠ¡ç¯å¢ƒæ‰èµ°ä»åº“
            DataSourceContext.setDataSourceKey("slave");
        }
    }

    // 4ï¸âƒ£ **æ‰€æœ‰å†™æ“ä½œï¼ˆinsert/update/deleteï¼‰èµ°ä¸»åº“**
    @Before("serviceMethods() && (execution(* com.example.service.*.insert*(..)) || " +
            "execution(* com.example.service.*.update*(..)) || " +
            "execution(* com.example.service.*.delete*(..)))")
    public void setWriteDataSource() {
        DataSourceContext.setDataSourceKey("master");
    }
}
```

### **ğŸ“Œ å…³é”®ç‚¹**

- **å¦‚æœæ–¹æ³•æœ‰ `@Transactional`ï¼Œåˆ™æ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šèµ°ä¸»åº“**ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰ã€‚
- **åªæœ‰éäº‹åŠ¡ç¯å¢ƒä¸‹ï¼Œæ‰å…è®¸æŸ¥è¯¢èµ°ä»åº“**ï¼ˆæé«˜æ€§èƒ½ï¼‰ã€‚
- **å†™æ“ä½œå§‹ç»ˆèµ°ä¸»åº“**ã€‚

------

## **âœ… æ–¹æ¡ˆ 2ï¼šæ‰‹åŠ¨æ§åˆ¶æ•°æ®æº**

å¦‚æœæƒ³**æ‰‹åŠ¨æ§åˆ¶æ•°æ®æº**ï¼Œå¯ä»¥æä¾› `@MasterOnly` æ³¨è§£ï¼Œç¡®ä¿æŸ¥è¯¢æ—¶èµ°ä¸»åº“ã€‚

### **ğŸ“Œ åˆ›å»º `@MasterOnly` è‡ªå®šä¹‰æ³¨è§£**

```java
javaå¤åˆ¶ç¼–è¾‘package com.example.annotation;

import java.lang.annotation.*;

@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface MasterOnly {
}
```

### **ğŸ“Œ AOP è¯†åˆ« `@MasterOnly`ï¼Œå¼ºåˆ¶èµ°ä¸»åº“**

```java
javaå¤åˆ¶ç¼–è¾‘@Before("@annotation(com.example.annotation.MasterOnly)")
public void forceMaster() {
    DataSourceContext.setDataSourceKey("master");
}
```

### **ğŸ“Œ åœ¨ Service å±‚ä½¿ç”¨**

```java
javaå¤åˆ¶ç¼–è¾‘@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;

    @MasterOnly  // å¼ºåˆ¶æŸ¥è¯¢ä¸»åº“
    public User getUserById(int id) {
        return userMapper.getUserById(id);
    }
}
```

è¿™æ ·ï¼Œåªè¦æ–¹æ³•åŠ ä¸Š `@MasterOnly`ï¼ŒæŸ¥è¯¢å°±ä¼šèµ°ä¸»åº“ï¼Œé¿å…äº‹åŠ¡å†…æ•°æ®ä¸ä¸€è‡´ã€‚

------

## **ğŸš€ ç»“è®º**

### **å¦‚ä½•ä¿è¯äº‹åŠ¡å†…æ•°æ®ä¸€è‡´ï¼Ÿ**

âœ… **äº‹åŠ¡å†…æ‰€æœ‰æŸ¥è¯¢å¼ºåˆ¶ä½¿ç”¨ä¸»åº“**ï¼ˆAOP å¤„ç†ï¼‰
âœ… **æ‰‹åŠ¨æ§åˆ¶æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ä¸»åº“ï¼ˆ@MasterOnlyï¼‰**
âœ… **å†™æ“ä½œå§‹ç»ˆèµ°ä¸»åº“**

è¿™æ ·ï¼Œæ—¢èƒ½**ä¿è¯äº‹åŠ¡æ•°æ®ä¸€è‡´æ€§**ï¼Œåˆèƒ½**æå‡æ€§èƒ½** ğŸš€s



### 2ã€æ•°æ®å»¶è¿Ÿé—®é¢˜

æ•°æ®å†™å…¥ä¹‹åå®¢æˆ·ç«¯åˆè¦å³æ—¶æŸ¥è¯¢å‡ºå†™å…¥çš„æ•°æ®ç»“æœï¼Œæ•°æ®å†™å…¥ä¸»åº“è¿˜æœªåŒæ­¥åˆ°ä»åº“ï¼Œå®¢æˆ·ç«¯çœ‹åˆ°æ•°æ®ä¸ä¸€è‡´ã€‚